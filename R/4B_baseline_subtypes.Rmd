---
title: "Baseline Subtype Discovery-Unsupervised Clustering"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

# Introduction



# Setup and Dependencies

```{r packages, message=FALSE, warning=FALSE, echo=TRUE}
suppressPackageStartupMessages({
library("purrr")
library("metafor")
library("dplyr")
library("readxl")
library("ggplot2")
library("tidyverse")
library("readr")
library("DESeq2")
library("dplyr")
library("stringr")
library("biomaRt")
library("inflection")  
library("ConsensusClusterPlus")  
library("cluster")
  
})
```


# 

```{r, message=FALSE, warning=FALSE, echo=TRUE}

processed_path <- "/mnt/vol1/Multi-Omics-Cancer-Subtype-Discovery/data/processed"

prot <- readRDS(file.path(processed_path, "proteomics_qc_imputed.rds"))
rna  <- readRDS(file.path(processed_path, "rna_filtered_imputed.rds"))

common <- intersect(rownames(prot), rownames(rna))
prot <- prot[common, , drop = FALSE]
rna  <- rna[common,  , drop = FALSE]


```

# Knee/elbow for RNA (top genes) and proteomics variance


- compute variance for each gene  
- sort variances decreasing  
- normalise rank and variance to 0–1  
- for a decreasing curve, flip it to increasing  
- find the point of maximum “gap” from the diagonal 


```{r, message=FALSE, warning=FALSE, echo=TRUE}

#Rank features by variability metric (MAD)
mad_rna  <- sort(apply(rna,  2, mad), decreasing = TRUE)
mad_prot <- sort(apply(prot, 2, mad), decreasing = TRUE)

# Knee/elbow = "how many top features to keep"
knee_rna  <- round(uik(seq_along(mad_rna), mad_rna))
knee_prot <- round(uik(seq_along(mad_prot), mad_prot))


cat("RNA knee (top genes):", knee_rna, "\n")
cat("Prot knee (top proteins):", knee_prot, "\n")

# Subset to knee-selected features
rna_k  <- rna[,  names(mad_rna)[1:knee_rna],   drop = FALSE]
prot_k <- prot[, names(mad_prot)[1:knee_prot], drop = FALSE]

cat("RNA kept:", ncol(rna_k), "\n")
cat("Prot kept:", ncol(prot_k), "\n")

plot(mad_rna, type="l", main="RNA variance (ranked)", xlab="Rank", ylab="Variance")
abline(v=knee_rna, lty=2)

plot(mad_prot, type="l", main="Proteomics variance (ranked)", xlab="Rank", ylab="Variance")
abline(v=knee_prot, lty=2)

```
# 

```{r, message=FALSE, warning=FALSE, echo=TRUE}

pca_prot <- prcomp(prot_k, center = TRUE, scale. = TRUE)
pca_rna <- prcomp(rna_k, center = TRUE, scale. = TRUE)

n_prot_pc <- min(10, ncol(pca_prot$x))
n_rna_pc <- min(10, ncol(pca_rna$x))

pcs <- cbind(
  pca_prot$x[, 1:n_prot_pc, drop=FALSE],
  pca_rna$x[,  1:n_rna_pc,  drop=FALSE]
)
colnames(pcs) <- c(paste0("ProtPC", 1:n_prot_pc), paste0("RnaPC", 1:n_rna_pc))
cat("PC matrix:", dim(pcs), "\n")


```


```{r, message=FALSE, warning=FALSE, echo=TRUE}

ks <- 2:10

#Elbow: total within-cluster sum of squares

wcss <- sapply(ks, function(k) kmeans(pcs, centers=k, nstart=25)$tot.withinss)

#Silhouette: separation quality

D <- dist(pcs)
sil <- sapply(ks, function(k) {
km <- kmeans(pcs, centers=k, nstart=25)
mean(silhouette(km$cluster, D)[, 3])
})

df_k <- data.frame(k = ks, wcss = wcss, silhouette = sil)
print(df_k)

ggplot(df_k, aes(k, wcss)) + geom_line() + geom_point() +
theme_bw() + labs(title="Elbow (WCSS) vs k", x="k", y="WCSS")

ggplot(df_k, aes(k, silhouette)) + geom_line() + geom_point() +
theme_bw() + labs(title="Silhouette vs k", x="k", y="Average silhouette")

k_best_sil <- df_k$k[which.max(df_k$silhouette)]
cat("Best k by silhouette:", k_best_sil, "\n")


```

# Stability (Consensus clustering) + simple PAC score

```{r, message=FALSE, warning=FALSE, echo=TRUE}
set.seed(1)

cc_dir <- file.path("/mnt/vol1/Multi-Omics-Cancer-Subtype-Discovery/results/figures/", "consensus_pcs")
cc <- ConsensusClusterPlus(
d = t(pcs),   
maxK = 10,
reps = 200,
pItem = 0.8,
pFeature = 1,
clusterAlg = "km",
distance = "euclidean",
seed = 1,
plot = "png",
title = cc_dir
)

# Lower PAC = more stable

pac <- sapply(2:10, function(k) {
C <- cc[[k]]$consensusMatrix
x <- C[upper.tri(C)]
mean(x > 0.1 & x < 0.9)
})

df_pac <- data.frame(k = 2:10, pac = pac)
print(df_pac)

ggplot(df_pac, aes(k, pac)) + geom_line() + geom_point() +
theme_bw() + labs(title="Stability (PAC) vs k (lower is better)", x="k", y="PAC")


```

# Fit final clustering + plot

Simple combined decision and take the top 3 silhouette k's.Among them, pick the one with lowest PAC

```{r, message=FALSE, warning=FALSE, echo=TRUE}

top3 <- df_k[order(-df_k$silhouette), ][1:3, "k"]

df_pac_top3 <- df_pac[df_pac$k %in% top3, ]
k_final <- df_pac_top3$k[which.min(df_pac_top3$pac)]

cat("Top 3 silhouette k:", paste(top3, collapse=", "), "\n")
print(df_pac_top3)
cat("Final k (lowest PAC among top 3 silhouette):", k_final, "\n")

```

```{r, message=FALSE, warning=FALSE, echo=TRUE}

set.seed(1)
km_final <- kmeans(pcs, centers = k_final, nstart = 50)

subtypes <- data.frame(subtype = paste0("C", km_final$cluster),
row.names = rownames(pcs))

print(table(subtypes$subtype))

# Save

write.csv(pcs, file.path(processed_path, "pca_20pcs.csv"))
write.csv(subtypes, file.path(processed_path, "subtype_labels.csv"))

write.csv(data.frame(feature = colnames(rna_k)),
file.path(processed_path, "rna_features_knee.csv"), row.names=FALSE)

write.csv(data.frame(feature = colnames(prot_k)),
file.path(processed_path, "prot_features_knee.csv"), row.names=FALSE)


```


